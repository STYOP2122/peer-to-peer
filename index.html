<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü—Ä–∏–≤–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --pink: #ec4899; --green: #10b981; --red: #ef4444; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        .card { background: var(--card); padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); width: 90%; max-width: 350px; text-align: center; }
        .btn { border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 12px; transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-pink { background: var(--pink); color: white; }
        .btn-call { background: var(--green); color: white; margin-top: 15px; }
        .btn-hangup { background: var(--red); color: white; margin-top: 15px; display: none; }
        .status-box { margin: 20px 0; padding: 10px; border-radius: 10px; background: rgba(0,0,0,0.2); font-size: 14px; color: #94a3b8; }
        .loader { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #94a3b8; margin-right: 5px; }
        .active-blink { animation: blink 1s infinite; background: var(--green) !important; box-shadow: 0 0 10px var(--green); }
        @keyframes blink { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
        select { width: 100%; padding: 12px; border-radius: 10px; background: #334155; color: white; border: 1px solid #475569; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div id="view-setup">
        <h2 style="margin-top:0">–ö—Ç–æ –≤—ã?</h2>
        <button class="btn btn-blue" onclick="startApp('armenia')">–Ø –ü–ê–†–ï–ù–¨ (–ê—Ä–º–µ–Ω–∏—è)</button>
        <button class="btn btn-pink" onclick="startApp('russia')">–Ø –î–ï–í–£–®–ö–ê (–†–æ—Å—Å–∏—è)</button>
    </div>

    <div id="view-call">
        <h3 id="role-name" style="color: #94a3b8;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞...</h3>
        <div class="status-box">
            <span id="loader" class="loader"></span>
            <span id="status-text">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
        </div>
        
        <button id="call-btn" class="btn btn-call" style="display:none" onclick="makeCall()">–ü–û–ó–í–û–ù–ò–¢–¨</button>
        
        <button id="hangup-btn" class="btn btn-hangup" onclick="hangUp()">–ó–ê–í–ï–†–®–ò–¢–¨ –ó–í–û–ù–û–ö</button>
        
        <div id="output-settings" style="text-align: left; margin-top: 20px; display:none;">
            <label style="font-size: 11px; color: #94a3b8;">–í–´–•–û–î –ó–í–£–ö–ê:</label>
            <select id="audio-output" onchange="changeOutput(this.value)">
                <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
            </select>
        </div>
    </div>
</div>

<audio id="remote-audio" autoplay playsinline></audio>

<script>
    const SECRET_KEY = "MY-PRIVATE-TALK-2026"; 
    let myPeerId, targetPeerId, localStream, peer, currentCall;

    async function startApp(role) {
        myPeerId = `${role}-${SECRET_KEY}`;
        targetPeerId = (role === 'armenia' ? 'russia' : 'armenia') + "-" + SECRET_KEY;
        
        document.getElementById('view-setup').style.display = 'none';
        document.getElementById('view-call').style.display = 'block';
        document.getElementById('role-name').innerText = role === 'armenia' ? "–ê—Ä–º–µ–Ω–∏—è üá¶üá≤" : "–†–æ—Å—Å–∏—è üá∑üá∫";

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            document.getElementById('status-text').innerText = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω";
            document.getElementById('call-btn').style.display = 'block';

            peer = new Peer(myPeerId, {
                config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }, { url: 'stun:stun1.l.google.com:19302' }] }
            });

            peer.on('open', () => { 
                document.getElementById('status-text').innerText = "–í —Å–µ—Ç–∏. –ú–æ–∂–Ω–æ –∑–≤–æ–Ω–∏—Ç—å."; 
            });

            // –ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –∑–≤–æ–Ω–∏—Ç –Ω–∞–º
            peer.on('call', (call) => {
                currentCall = call;
                call.answer(localStream);
                setupRemoteStream(call);
            });

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏–Ω–∞–º–∏–∫–æ–≤
            const devices = await navigator.mediaDevices.enumerateDevices();
            const select = document.getElementById('audio-output');
            const outputs = devices.filter(d => d.kind === 'audiooutput');
            if (outputs.length > 0) {
                document.getElementById('output-settings').style.display = 'block';
                outputs.forEach(d => {
                    let opt = document.createElement('option');
                    opt.value = d.deviceId; opt.text = d.label || `–î–∏–Ω–∞–º–∏–∫ ${select.length}`;
                    select.appendChild(opt);
                });
            }
        } catch (err) {
            alert("–û—à–∏–±–∫–∞: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTTPS –∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
        }
    }

    function setupRemoteStream(call) {
        // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('call-btn').style.display = 'none';
        document.getElementById('hangup-btn').style.display = 'block';
        document.getElementById('loader').classList.add('active-blink');

        call.on('stream', (stream) => {
            const audio = document.getElementById('remote-audio');
            audio.srcObject = stream;
            audio.play();
            document.getElementById('status-text').innerText = "–†–ê–ó–ì–û–í–û–†...";
        });

        // –ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–∂–∞–ª "–ó–∞–≤–µ—Ä—à–∏—Ç—å", —É –Ω–∞—Å —Ç–æ–∂–µ –≤—Å—ë —Å–±—Ä–æ—Å–∏—Ç—Å—è
        call.on('close', () => { resetUI(); });
        call.on('error', () => { resetUI(); });
    }

    function makeCall() {
        document.getElementById('status-text').innerText = "–í—ã–∑–æ–≤...";
        currentCall = peer.call(targetPeerId, localStream);
        setupRemoteStream(currentCall);
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
    function hangUp() {
        if (currentCall) {
            currentCall.close(); // –≠—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–∏–≥–Ω–∞–ª "close" –¥—Ä—É–≥–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É
        }
        resetUI();
    }

    function resetUI() {
        const audio = document.getElementById('remote-audio');
        audio.srcObject = null;
        document.getElementById('status-text').innerText = "–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω";
        document.getElementById('call-btn').style.display = 'block';
        document.getElementById('hangup-btn').style.display = 'none';
        document.getElementById('loader').classList.remove('active-blink');
        
        setTimeout(() => {
            if (!currentCall || !currentCall.open) {
                document.getElementById('status-text').innerText = "–í —Å–µ—Ç–∏. –ú–æ–∂–Ω–æ –∑–≤–æ–Ω–∏—Ç—å.";
            }
        }, 2000);
    }

    async function changeOutput(id) {
        const audio = document.getElementById('remote-audio');
        if (audio.setSinkId) await audio.setSinkId(id);
    }
</script>
</body>
</html>
