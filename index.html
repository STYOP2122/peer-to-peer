<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Voice Dynamic</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- Discord Theme Colors & Reset --- */
        :root {
            --bg-tertiary: #1e1f22; 
            --bg-secondary: #2b2d31; 
            --bg-primary: #313338; 
            --text-normal: #dbdee1;
            --text-muted: #949ba4;
            --interactive-hover: #3f4147;
            --interactive-active: #5865f2; 
            --green: #23a559;
            --red: #da373c;
            --control-bg: #232428;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'gg sans', 'Noto Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--bg-primary); color: var(--text-normal); height: 100vh; display: flex; overflow: hidden; }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-primary); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .login-card {
            background: var(--bg-secondary); padding: 30px; border-radius: 8px;
            text-align: center; box-shadow: 0 8px 16px rgba(0,0,0,0.24); width: 300px;
        }
        .login-btn {
            display: block; width: 100%; padding: 12px; margin: 10px 0; border: none;
            border-radius: 4px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn-arm { background: var(--interactive-active); }
        .btn-rus { background: #eb459e; }

        /* --- UI Components --- */
        .sidebar { width: 72px; background: var(--bg-tertiary); display: flex; flex-direction: column; align-items: center; padding-top: 12px; }
        .server-icon { width: 48px; height: 48px; background: var(--interactive-active); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-bottom: 10px; }
        
        .channels { width: 240px; background: var(--bg-secondary); display: flex; flex-direction: column; }
        .channel-header { padding: 12px 16px; border-bottom: 1px solid #1f2023; font-weight: bold; box-shadow: 0 1px 0 rgba(4,4,5,0.2); }
        
        .channel-list { padding: 8px; flex-grow: 1; }
        .voice-channel {
            padding: 8px; border-radius: 4px; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; margin-bottom: 2px;
        }
        .voice-channel:hover { background: var(--interactive-hover); color: var(--text-normal); }
        .voice-channel.active { background: rgba(88, 101, 242, 0.1); color: white; }
        .vc-icon { margin-right: 6px; width: 20px; height: 20px; fill: currentColor; }

        /* --- Users List --- */
        .user-container { padding-left: 28px; margin-top: 4px; display: flex; flex-direction: column; gap: 2px; }
        /* По умолчанию скрываем пользователей, показываем только если они онлайн */
        .user-row { display: flex; align-items: center; padding: 6px 8px; border-radius: 4px; opacity: 0.3; transition: opacity 0.3s; }
        .user-row.is-online { opacity: 1; } 
        
        /* Если пользователь вошел в канал - подсвечиваем фон */
        .user-row.in-channel { background: rgba(255,255,255,0.05); }

        .avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; background: #5c5e66; position: relative; border: 2px solid transparent; transition: border-color 0.2s; }
        .avatar.speaking { border-color: var(--green); }
        .username { font-size: 14px; font-weight: 500; color: var(--text-muted); }
        .user-row.is-online .username { color: white; }
        
        /* Status Icons inside User List */
        .status-icons { margin-left: auto; display: flex; gap: 5px; }
        .s-icon { width: 14px; height: 14px; color: var(--red); display: none; }
        .user-row[data-mic="false"] .icon-mic-off { display: block; }
        .user-row[data-sound="false"] .icon-head-off { display: block; }

        /* Status Dot (Green/Grey) */
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; background: #4e5058; border: 2px solid var(--bg-secondary); position: absolute; bottom: -2px; right: -2px; }
        .user-row.is-online .status-indicator { background: var(--green); }

        /* --- Bottom Controls --- */
        .user-area { background: var(--control-bg); padding: 8px; display: flex; align-items: center; justify-content: space-between; }
        .my-info { display: flex; align-items: center; }
        .my-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--interactive-active); margin-right: 8px; }
        .my-name { font-size: 13px; font-weight: bold; display: block; }
        .my-status { font-size: 11px; color: var(--text-muted); }
        
        .controls { display: flex; gap: 4px; }
        .control-btn {
            width: 32px; height: 32px; border-radius: 4px; border: none; background: transparent;
            color: var(--text-normal); cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative;
        }
        .control-btn:hover { background: var(--interactive-hover); }
        .strikethrough { position: absolute; width: 100%; height: 2px; background: var(--red); transform: rotate(45deg); display: none; }
        .control-btn.muted .strikethrough { display: block; }
        .control-btn.muted { color: var(--red); }
        .control-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- Chat Area --- */
        .chat-area { flex-grow: 1; background: var(--bg-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); text-align: center; }
        .btn-join { background: var(--green); color: white; padding: 10px 24px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; margin-top: 20px; }
        .btn-leave { background: var(--red); display: none; color: white; padding: 10px 24px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2 style="color:white; margin-bottom: 20px;">Кто ты?</h2>
        <button class="login-btn btn-arm" onclick="initApp('armenia')">Я ПАРЕНЬ (Армения)</button>
        <button class="login-btn btn-rus" onclick="initApp('russia')">Я ДЕВУШКА (Россия)</button>
    </div>
</div>

<div class="sidebar">
    <div class="server-icon">D</div>
</div>

<div class="channels">
    <div class="channel-header">Приватный сервер</div>
    <div class="channel-list">
        <div class="voice-channel" id="voice-channel-btn" onclick="toggleChannelJoin()">
            <svg class="vc-icon" viewBox="0 0 24 24"><path d="M11.383 3.07904C11.009 2.92504 10.579 3.01004 10.293 3.29604L6 8.00204H3C2.45 8.00204 2 8.45304 2 9.00204V15.002C2 15.552 2.45 16.002 3 16.002H6L10.293 20.71C10.579 20.996 11.009 21.082 11.383 20.927C11.758 20.772 12 20.407 12 20.002V4.00204C12 3.59904 11.758 3.23204 11.383 3.07904ZM14 5.00195V7.00195C16.757 7.00195 19 9.24595 19 12.002C19 14.759 16.757 17.002 14 17.002V19.002C17.86 19.002 21 15.863 21 12.002C21 8.14295 17.86 5.00195 14 5.00195Z"></path></svg>
            <span>Голосовой канал</span>
        </div>
        
        <div class="user-container">
            <div class="user-row" id="row-armenia" data-mic="true" data-sound="true">
                <div class="avatar"><div class="status-indicator"></div></div>
                <div style="flex-grow:1;"><span class="username">Армения</span></div>
                <div class="status-icons">
                    <svg class="s-icon icon-mic-off" viewBox="0 0 24 24"><path fill="currentColor" d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l2.97 2.97c-.85.45-1.79.7-2.65.68v2h1.17l3.2 3.2 1.27-1.27-14.34-14.23z"></path></svg>
                    <svg class="s-icon icon-head-off" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4a9 9 0 0 0-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h4v1h-7v2h6c1.66 0 3-1.34 3-3V13a9 9 0 0 0-9-9z"></path><path fill="currentColor" d="M2.27 2.27L1 3.54l2.78 2.78A8.95 8.95 0 0 0 3 13v7c0 1.66 1.34 3 3 3h5v-8H7v-2c0-2.32 1.13-4.38 2.87-5.71L12 11.46V13h3.46l5 5h.54v-1.46L21.46 22l1.27-1.27L2.27 2.27z"></path></svg>
                </div>
            </div>
            <div class="user-row" id="row-russia" data-mic="true" data-sound="true">
                <div class="avatar" style="background:#eb459e;"><div class="status-indicator"></div></div>
                <div style="flex-grow:1;"><span class="username">Россия</span></div>
                <div class="status-icons">
                    <svg class="s-icon icon-mic-off" viewBox="0 0 24 24"><path fill="currentColor" d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l2.97 2.97c-.85.45-1.79.7-2.65.68v2h1.17l3.2 3.2 1.27-1.27-14.34-14.23z"></path></svg>
                    <svg class="s-icon icon-head-off" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4a9 9 0 0 0-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h4v1h-7v2h6c1.66 0 3-1.34 3-3V13a9 9 0 0 0-9-9z"></path><path fill="currentColor" d="M2.27 2.27L1 3.54l2.78 2.78A8.95 8.95 0 0 0 3 13v7c0 1.66 1.34 3 3 3h5v-8H7v-2c0-2.32 1.13-4.38 2.87-5.71L12 11.46V13h3.46l5 5h.54v-1.46L21.46 22l1.27-1.27L2.27 2.27z"></path></svg>
                </div>
            </div>
        </div>
    </div>

    <div class="user-area">
        <div class="my-info">
            <div class="my-avatar" id="my-avatar-img"></div>
            <div>
                <span class="my-name" id="my-ui-name">...</span>
                <span class="my-status">В сети</span>
            </div>
        </div>
        <div class="controls">
            <button class="control-btn" id="btn-mic" onclick="toggleMic()">
                <div class="strikethrough"></div>
                <svg viewBox="0 0 24 24"><path d="M12 2C9.243 2 7 4.243 7 7V13C7 15.757 9.243 18 12 18C14.757 18 17 15.757 17 13V7C17 4.243 14.757 2 12 2ZM19 13C19 16.486 16.486 19 13 19.899V22H11V19.899C7.514 19 5 16.486 5 13H7C7 15.757 9.243 18 12 18C14.757 18 17 15.757 17 13H19Z"></path></svg>
            </button>
            <button class="control-btn" id="btn-sound" onclick="toggleDeafen()">
                <div class="strikethrough"></div>
                <svg viewBox="0 0 24 24"><path d="M12 3C7.029 3 3 7.029 3 12V16C3 18.209 4.791 20 7 20H8V11H5V12C5 8.131 8.131 5 12 5C15.869 5 19 8.131 19 12V13H16V22H17C19.209 22 21 20.209 21 18V12C21 7.029 16.971 3 12 3Z"></path></svg>
            </button>
        </div>
    </div>
</div>

<div class="chat-area">
    <h2>Голосовой чат</h2>
    <p>Нажмите кнопку ниже или канал слева</p>
    <button id="main-join-btn" class="btn-join" onclick="toggleChannelJoin()">Войти в канал</button>
    <button id="main-leave-btn" class="btn-leave" onclick="toggleChannelJoin()">Отключиться</button>
</div>

<audio id="remote-audio" autoplay playsinline></audio>

<script>
    const KEY_PREFIX = "DISCORD-V2-";
    let peer, localStream, mediaCall, dataConn;
    let myRole, targetId;
    
    // Мое состояние
    let myState = {
        mic: true,
        sound: true,
        joined: false, // Нахожусь ли я в канале
        online: true   // Сам факт присутствия
    };

    // Состояние собеседника
    let peerLastSeen = 0; // Timestamp последнего сигнала

    async function initApp(role) {
        myRole = role;
        const myId = KEY_PREFIX + role;
        targetId = KEY_PREFIX + (role === 'armenia' ? 'russia' : 'armenia');

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('my-ui-name').innerText = role === 'armenia' ? "Армения" : "Россия";
        if(role === 'russia') document.getElementById('my-avatar-img').style.backgroundColor = '#eb459e';

        // 1. Показываем себя "онлайн" в списке
        updateRowUI(myRole, myState, true);

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            peer = new Peer(myId, {
                config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] }
            });

            peer.on('open', () => {
                console.log("My Peer ID:", myId);
                connectDataLoop(); // Начинаем долбиться в data-канал
            });

            // Входящее DATA соединение (текст/статус)
            peer.on('connection', (conn) => {
                setupDataConnection(conn);
            });

            // Входящее MEDIA соединение (звук)
            peer.on('call', (call) => {
                if(myState.joined) {
                    call.answer(localStream);
                    handleMediaCall(call);
                }
            });

        } catch(e) { alert("Ошибка микрофона: " + e); }

        // Запускаем цикл отправки своего статуса
        setInterval(broadcastState, 1000); 
        // Запускаем проверку "жив ли собеседник"
        setInterval(checkPeerAlive, 2000);
    }

    // --- Логика Data (Статусы) ---

    function connectDataLoop() {
        // Если соединения нет, пытаемся подключиться к собеседнику
        if (!dataConn || !dataConn.open) {
            const conn = peer.connect(targetId, { reliable: true });
            setupDataConnection(conn);
        }
    }

    function setupDataConnection(conn) {
        conn.on('open', () => {
            dataConn = conn;
            // Сразу отправляем свой статус
            broadcastState();
        });

        conn.on('data', (data) => {
            // Пришли данные от собеседника!
            if (data.type === 'state') {
                peerLastSeen = Date.now(); // Обновляем "время жизни"
                const otherRole = myRole === 'armenia' ? 'russia' : 'armenia';
                updateRowUI(otherRole, data.payload, true);
            }
        });

        conn.on('error', () => { dataConn = null; });
    }

    function broadcastState() {
        if (dataConn && dataConn.open) {
            dataConn.send({ type: 'state', payload: myState });
        } else {
            // Если соединение упало, пробуем восстановить
            connectDataLoop();
        }
    }

    function checkPeerAlive() {
        const otherRole = myRole === 'armenia' ? 'russia' : 'armenia';
        // Если от собеседника не было вестей больше 5 секунд -> он оффлайн
        if (Date.now() - peerLastSeen > 5000) {
            updateRowUI(otherRole, { mic: true, sound: true, joined: false }, false);
        }
    }

    // --- Логика Media (Звук) ---

    function toggleChannelJoin() {
        myState.joined = !myState.joined;
        
        // Обновляем UI для себя
        updateMainButtonUI();
        updateRowUI(myRole, myState, true);
        broadcastState(); // Срочно сообщаем собеседнику

        if (myState.joined) {
            // Пытаемся позвонить
            if(peer) {
                mediaCall = peer.call(targetId, localStream);
                if(mediaCall) handleMediaCall(mediaCall);
            }
        } else {
            // Выходим
            if (mediaCall) mediaCall.close();
            document.getElementById('remote-audio').srcObject = null;
        }
    }

    function handleMediaCall(call) {
        mediaCall = call;
        call.on('stream', stream => {
            document.getElementById('remote-audio').srcObject = stream;
        });
        // Простая имитация "говорения" (Border green)
        // В реальном app нужен AudioContext для анализа громкости
    }

    // --- UI Update Functions ---

    function updateRowUI(role, state, isOnline) {
        const row = document.getElementById(`row-${role}`);
        
        if (isOnline) {
            row.classList.add('is-online');
            
            // Если человек "Joined" - меняем фон строки
            if (state.joined) row.classList.add('in-channel');
            else row.classList.remove('in-channel');

            // Иконки заглушенности
            row.setAttribute('data-mic', state.mic);
            row.setAttribute('data-sound', state.sound);

        } else {
            row.classList.remove('is-online');
            row.classList.remove('in-channel');
        }
    }

    function updateMainButtonUI() {
        const joinBtn = document.getElementById('main-join-btn');
        const leaveBtn = document.getElementById('main-leave-btn');
        const channelBtn = document.getElementById('voice-channel-btn');

        if (myState.joined) {
            joinBtn.style.display = 'none';
            leaveBtn.style.display = 'inline-block';
            channelBtn.classList.add('active');
        } else {
            joinBtn.style.display = 'inline-block';
            leaveBtn.style.display = 'none';
            channelBtn.classList.remove('active');
        }
    }

    // --- Кнопки управления ---

    function toggleMic() {
        myState.mic = !myState.mic;
        localStream.getAudioTracks()[0].enabled = myState.mic;
        
        const btn = document.getElementById('btn-mic');
        btn.classList.toggle('muted', !myState.mic);
        
        updateRowUI(myRole, myState, true); // Обновляем себя
        broadcastState(); // Шлем инфо собеседнику
    }

    function toggleDeafen() {
        myState.sound = !myState.sound;
        document.getElementById('remote-audio').muted = !myState.sound;
        
        const btn = document.getElementById('btn-sound');
        btn.classList.toggle('muted', !myState.sound);
        
        updateRowUI(myRole, myState, true); // Обновляем себя
        broadcastState(); // Шлем инфо собеседнику
    }

</script>
</body>
</html>
