<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Private Link</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --pink: #ec4899; --green: #10b981; --red: #ef4444; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: var(--card); padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); width: 90%; max-width: 350px; text-align: center; }
        .btn { border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 12px; transition: 0.2s; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-pink { background: var(--pink); color: white; }
        .btn-call { background: var(--green); color: white; margin-top: 15px; }
        .btn-hangup { background: var(--red); color: white; margin-top: 15px; display: none; }
        .status-box { margin: 20px 0; padding: 12px; border-radius: 12px; background: rgba(0,0,0,0.3); font-size: 14px; border: 1px solid #334155; }
        .loader { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #475569; margin-right: 8px; }
        .online { background: var(--green); box-shadow: 0 0 10px var(--green); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        select { width: 100%; padding: 12px; border-radius: 10px; background: #334155; color: white; border: 1px solid #475569; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div id="view-setup">
        <h2 style="margin-top:0">–í—ã–±–æ—Ä —Ä–æ–ª–∏</h2>
        <button class="btn btn-blue" onclick="startApp('armenia')">–Ø –ü–ê–†–ï–ù–¨ (–ê—Ä–º–µ–Ω–∏—è)</button>
        <button class="btn btn-pink" onclick="startApp('russia')">–Ø –î–ï–í–£–®–ö–ê (–†–æ—Å—Å–∏—è)</button>
    </div>

    <div id="view-call">
        <h3 id="role-name" style="color: #94a3b8; margin-bottom: 5px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞...</h3>
        <div class="status-box">
            <span id="dot" class="loader"></span>
            <span id="status-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span>
        </div>
        
        <button id="call-btn" class="btn btn-call" style="display:none" onclick="makeCall()">–ü–û–ó–í–û–ù–ò–¢–¨</button>
        <button id="hangup-btn" class="btn btn-hangup" onclick="hangUp()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
        
        <div id="output-settings" style="text-align: left; margin-top: 20px; display:none;">
            <label style="font-size: 11px; color: #94a3b8; padding-left: 5px;">–í–´–í–û–î –ó–í–£–ö–ê:</label>
            <select id="audio-output" onchange="changeOutput(this.value)">
                <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
            </select>
        </div>
    </div>
</div>

<audio id="remote-audio" autoplay playsinline></audio>

<script>
    // 1. –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á (–∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π —Å–µ–∫—Ä–µ—Ç)
    const SECRET_KEY = "OUR-STABLE-LINK-2026"; 
    let myPeerId, targetPeerId, localStream, peer, currentCall;

    async function startApp(role) {
        myPeerId = `${role}-${SECRET_KEY}`;
        targetPeerId = (role === 'armenia' ? 'russia' : 'armenia') + "-" + SECRET_KEY;
        
        document.getElementById('view-setup').style.display = 'none';
        document.getElementById('view-call').style.display = 'block';
        document.getElementById('role-name').innerText = (role === 'armenia' ? "–ê—Ä–º–µ–Ω–∏—è üá¶üá≤" : "–†–æ—Å—Å–∏—è üá∑üá∫");

        try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
            localStream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: true, noiseSuppression: true } 
            });
            document.getElementById('status-text').innerText = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤";
            document.getElementById('call-btn').style.display = 'block';

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PeerJS —Å –º–æ—â–Ω—ã–º–∏ STUN-—Å–µ—Ä–≤–µ—Ä–∞–º–∏
            peer = new Peer(myPeerId, {
                config: {
                    'iceServers': [
                        { url: 'stun:stun.l.google.com:19302' },
                        { url: 'stun:stun1.l.google.com:19302' },
                        { url: 'stun:stun2.l.google.com:19302' },
                        { url: 'stun:stun3.l.google.com:19302' },
                        { url: 'stun:stun4.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                document.getElementById('status-text').innerText = "–í —Å–µ—Ç–∏. –û–∂–∏–¥–∞–Ω–∏–µ...";
                document.getElementById('dot').classList.add('online');
            });

            peer.on('call', (call) => {
                currentCall = call;
                call.answer(localStream);
                setupCallHandlers(call);
            });

            peer.on('error', (err) => {
                console.error('PeerJS Error:', err.type);
                if(err.type === 'peer-unavailable') {
                    alert("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –µ—â–µ –Ω–µ –∑–∞—à–µ–ª –≤ —Å–µ—Ç—å.");
                    resetUI();
                }
            });

            // –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤—ã–≤–æ–¥–∞
            const devices = await navigator.mediaDevices.enumerateDevices();
            const select = document.getElementById('audio-output');
            const outputs = devices.filter(d => d.kind === 'audiooutput');
            if (outputs.length > 0) {
                document.getElementById('output-settings').style.display = 'block';
                outputs.forEach(d => {
                    let opt = document.createElement('option');
                    opt.value = d.deviceId; opt.text = d.label || `–î–∏–Ω–∞–º–∏–∫ ${select.length}`;
                    select.appendChild(opt);
                });
            }

        } catch (err) {
            document.getElementById('status-text').innerText = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞!";
            alert("–ù—É–∂–µ–Ω HTTPS –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω.");
        }
    }

    function makeCall() {
        document.getElementById('status-text').innerText = "–í—ã–∑–æ–≤...";
        currentCall = peer.call(targetPeerId, localStream);
        setupCallHandlers(currentCall);
    }

    function setupCallHandlers(call) {
        document.getElementById('call-btn').style.display = 'none';
        document.getElementById('hangup-btn').style.display = 'block';

        call.on('stream', (stream) => {
            const audio = document.getElementById('remote-audio');
            audio.srcObject = stream;
            audio.play().catch(e => console.log("Play blocked"));
            document.getElementById('status-text').innerText = "–ì–û–í–û–†–ò–ú";
        });

        call.on('close', () => resetUI());
        call.on('error', () => resetUI());
    }

    function hangUp() {
        if (currentCall) currentCall.close();
        resetUI();
    }

    function resetUI() {
        const audio = document.getElementById('remote-audio');
        audio.srcObject = null;
        document.getElementById('status-text').innerText = "–í —Å–µ—Ç–∏. –û–∂–∏–¥–∞–Ω–∏–µ...";
        document.getElementById('call-btn').style.display = 'block';
        document.getElementById('hangup-btn').style.display = 'none';
    }

    async function changeOutput(id) {
        const audio = document.getElementById('remote-audio');
        if (audio.setSinkId) await audio.setSinkId(id);
    }
</script>
</body>
</html>
