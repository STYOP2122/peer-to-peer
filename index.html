<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Voice Channel</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #313338; --sidebar: #2b2d31; --card: #1e1f22; --text: #dbdee1; --accent: #5865f2; --green: #23a559; --red: #da373c; --yellow: #f0b232; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        .app-container { background: var(--card); width: 90%; max-width: 400px; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.6); display: flex; flex-direction: column; }
        
        /* Header */
        .header { background: var(--sidebar); padding: 15px; text-align: center; border-bottom: 1px solid #1e1f22; font-weight: 800; letter-spacing: 1px; color: #fff; }
        
        /* Setup View */
        #view-setup { padding: 40px 20px; display: flex; flex-direction: column; gap: 15px; text-align: center; }
        .setup-title { margin-bottom: 10px; font-size: 1.1em; color: #949ba4; }
        
        /* Main View */
        #view-chat { display: none; }
        .channel-info { padding: 20px; }
        .user-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; border: 1px solid transparent; transition: 0.3s; }
        .user-row.active { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); }
        
        .user-name { display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #4e5058; box-shadow: 0 0 0 2px var(--card); transition: 0.3s; }
        .status-dot.online { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .status-dot.busy { background: var(--red); }
        
        .status-text { font-size: 0.8em; margin-top: 15px; text-align: center; color: #949ba4; min-height: 1.2em; }
        
        /* Controls */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 20px; background: var(--sidebar); border-top: 1px solid #1e1f22; }
        .btn { border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: 700; color: white; transition: 0.2s; font-size: 0.9em; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        
        .btn-call { grid-column: span 2; background: var(--green); }
        .btn-call:disabled { background: #4e5058; cursor: not-allowed; opacity: 0.7; }
        .btn-hangup { grid-column: span 2; background: var(--red); display: none; }
        
        .btn-mute { background: #4e5058; }
        .btn-mute.muted { background: var(--red); position: relative; }
        .btn-mute.muted::after { content: ''; position: absolute; width: 80%; height: 2px; background: white; transform: rotate(-45deg); }

        /* Logs for debug (hidden usually) */
        #debug-log { font-size: 10px; color: #555; text-align: center; padding: 5px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">üîí PRIVATE VOICE</div>

    <div id="view-setup">
        <div class="setup-title">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Å—Ç–æ—Ä–æ–Ω—É</div>
        <button class="btn" style="background: var(--accent);" onclick="startApp('armenia')">–ê—Ä–º–µ–Ω–∏—è</button>
        <button class="btn" style="background: #eb459e;" onclick="startApp('russia')">–†–æ—Å—Å–∏—è</button>
    </div>

    <div id="view-chat">
        <div class="channel-info">
            <div class="user-row" id="row-armenia">
                <div class="user-name">–ê—Ä–º–µ–Ω–∏—è</div>
                <div id="status-armenia" class="status-dot"></div>
            </div>
            <div class="user-row" id="row-russia">
                <div class="user-name">–†–æ—Å—Å–∏—è</div>
                <div id="status-russia" class="status-dot"></div>
            </div>
            <div id="app-status" class="status-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>

        <div class="controls">
            <button id="btn-connect" class="btn btn-call" onclick="startCall()" disabled>–û–ñ–ò–î–ê–ù–ò–ï –°–û–ë–ï–°–ï–î–ù–ò–ö–ê...</button>
            <button id="btn-hangup" class="btn btn-hangup" onclick="endCall()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
            
            <button id="btn-mic" class="btn btn-mute" onclick="toggleMic()">üé§</button>
            <button id="btn-audio" class="btn btn-mute" onclick="toggleAudio()">üéß</button>
        </div>
        <div id="debug-log">v3.0 Stable</div>
    </div>
</div>

<audio id="remote-audio" autoplay playsinline></audio>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    const APP_ID = "PRIVATE_V3_2026"; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
    const PEER_CONFIG = {
        debug: 1,
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' }
            ]
        }
    };

    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    let myRole = null; // 'armenia' or 'russia'
    let targetRole = null;
    let peer = null;
    let localStream = null;
    let currentCall = null;
    let dataConn = null; // –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
    let isMicMuted = false;
    let isAudioMuted = false;
    let connectionRetryInterval = null;

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    async function startApp(role) {
        myRole = role;
        targetRole = (role === 'armenia' ? 'russia' : 'armenia');
        
        // UI
        document.getElementById('view-setup').style.display = 'none';
        document.getElementById('view-chat').style.display = 'block';
        document.getElementById(`status-${myRole}`).classList.add('online'); // –Ø –≤—Å–µ–≥–¥–∞ –æ–Ω–ª–∞–π–Ω –¥–ª—è —Å–µ–±—è

        try {
            updateStatus("–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...");
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            
            initPeer();
        } catch (err) {
            alert("–û—à–∏–±–∫–∞: –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É! " + err.message);
            updateStatus("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
        }
    }

    function initPeer() {
        const myPeerId = `${myRole}_${APP_ID}`;
        updateStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...");

        peer = new Peer(myPeerId, PEER_CONFIG);

        peer.on('open', (id) => {
            updateStatus("–í —Å–µ—Ç–∏. –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...");
            startConnectionLoop(); // –ù–∞—á–∏–Ω–∞–µ–º –∏—Å–∫–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞
        });

        peer.on('error', (err) => {
            console.error(err);
            if(err.type === 'peer-unavailable') {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, —Ç–∞–∫ –∫–∞–∫ —Ü–∏–∫–ª –ø–æ–∏—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ
            } else if (err.type === 'unavailable-id') {
                alert("–≠—Ç–∞ —Ä–æ–ª—å —É–∂–µ –∑–∞–Ω—è—Ç–∞! –í–æ–∑–º–æ–∂–Ω–æ, –≤–∫–ª–∞–¥–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞.");
            } else {
                updateStatus("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.type);
            }
        });

        // –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
        peer.on('call', (call) => {
            if (currentCall) { 
                call.close(); // –ó–∞–Ω—è—Ç–æ
                return; 
            }
            if(!confirm("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫! –ü—Ä–∏–Ω—è—Ç—å?")) { // –î–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è
                call.close();
                return;
            }
            handleCall(call);
        });

        // –í—Ö–æ–¥—è—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Å—Ç–∞—Ç—É—Å)
        peer.on('connection', (conn) => {
            handleDataConnection(conn);
        });
    }

    // --- –õ–û–ì–ò–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø (–°–ï–†–î–¶–ï –°–ò–°–¢–ï–ú–´) ---
    
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø–∞—Ä—Ç–Ω–µ—Ä—É –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    function startConnectionLoop() {
        if (connectionRetryInterval) clearInterval(connectionRetryInterval);
        
        connectionRetryInterval = setInterval(() => {
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (dataConn && dataConn.open) return;

            const targetId = `${targetRole}_${APP_ID}`;
            const conn = peer.connect(targetId, { reliable: true });
            
            configureDataConnection(conn);

        }, 3000);
    }

    function handleDataConnection(conn) {
        // –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ –Ω–∞–º, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        if (dataConn && dataConn.open) {
            conn.close(); // –£ –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å —Å–≤—è–∑—å
            return;
        }
        configureDataConnection(conn);
    }

    function configureDataConnection(conn) {
        conn.on('open', () => {
            console.log("Data connection opened");
            dataConn = conn;
            setPartnerOnline(true);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è
            dataConn.send({ type: 'hello' });
        });

        conn.on('data', (data) => {
            if(data.type === 'hangup') endCall(false); // false = –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–∏–≥–Ω–∞–ª –æ–±—Ä–∞—Ç–Ω–æ
        });

        conn.on('close', () => {
            console.log("Data connection closed");
            dataConn = null;
            setPartnerOnline(false);
            endCall(false); // –ï—Å–ª–∏ —Ä–∞–∑–æ—Ä–≤–∞–ª—Å—è –∫–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö, —Ä–≤–µ–º –∏ –∑–≤–æ–Ω–æ–∫
        });
        
        conn.on('error', (err) => {
            console.log("Data conn error", err);
            // PeerJS —Å–∞–º –≤—ã–∑–æ–≤–µ—Ç close
        });
    }

    // --- UI –§–£–ù–ö–¶–ò–ò ---

    function setPartnerOnline(isOnline) {
        const dot = document.getElementById(`status-${targetRole}`);
        const btn = document.getElementById('btn-connect');
        
        if (isOnline) {
            dot.classList.add('online');
            btn.disabled = false;
            btn.innerText = "–ü–û–ó–í–û–ù–ò–¢–¨";
            btn.style.background = "var(--green)";
            updateStatus("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤ —Å–µ—Ç–∏");
        } else {
            dot.classList.remove('online');
            btn.disabled = true;
            btn.innerText = "–û–ñ–ò–î–ê–ù–ò–ï...";
            btn.style.background = "#4e5058";
            updateStatus("–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...");
        }
    }

    function updateStatus(msg) {
        document.getElementById('app-status').innerText = msg;
    }

    // --- –õ–û–ì–ò–ö–ê –ó–í–û–ù–ö–ê ---

    function startCall() {
        const targetId = `${targetRole}_${APP_ID}`;
        updateStatus("–ó–≤–æ–Ω–∏–º...");
        const call = peer.call(targetId, localStream);
        handleCall(call);
    }

    function handleCall(call) {
        // –û—Ç–≤–µ—á–∞–µ–º
        call.answer(localStream);
        currentCall = call;

        // UI
        document.getElementById('btn-connect').style.display = 'none';
        document.getElementById('btn-hangup').style.display = 'block';
        updateStatus("üîä –ê—É–¥–∏–æ —Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
        
        // –í–∫–ª—é—á–∞–µ–º –∑–≤—É–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
        call.on('stream', (remoteStream) => {
            const audio = document.getElementById('remote-audio');
            audio.srcObject = remoteStream;
            audio.play().catch(e => console.error("Autoplay prevent:", e));
        });

        call.on('close', () => {
            resetCallUI();
        });
        
        call.on('error', () => {
            resetCallUI();
        });
    }

    function endCall(sendSignal = true) {
        if (currentCall) {
            currentCall.close();
            currentCall = null;
        }
        if (sendSignal && dataConn && dataConn.open) {
            dataConn.send({ type: 'hangup' });
        }
        resetCallUI();
    }

    function resetCallUI() {
        document.getElementById('btn-connect').style.display = 'block';
        document.getElementById('btn-hangup').style.display = 'none';
        if(dataConn && dataConn.open) {
            updateStatus("–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω");
        } else {
            updateStatus("–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...");
        }
    }

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ï–î–ò–ê ---

    function toggleMic() {
        isMicMuted = !isMicMuted;
        localStream.getAudioTracks()[0].enabled = !isMicMuted;
        const btn = document.getElementById('btn-mic');
        btn.classList.toggle('muted', isMicMuted);
    }

    function toggleAudio() {
        isAudioMuted = !isAudioMuted;
        document.getElementById('remote-audio').muted = isAudioMuted;
        const btn = document.getElementById('btn-audio');
        btn.classList.toggle('muted', isAudioMuted);
    }

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.onbeforeunload = function() {
        if(peer) peer.destroy();
    };
</script>
</body>
</html>
